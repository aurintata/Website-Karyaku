<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran QRIS - Karyaku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="home.html">Karyaku</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="marketplace.html">Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link" href="creator-profile.html">Kreator</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-5 pb-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-lg border-0 text-center">
                    <div class="card-body p-4 p-md-5">
                        <h2 class="fw-bold mb-3">Lakukan Pembayaran</h2>
                        <p class="text-muted">Pindai kode QRIS di bawah ini untuk menyelesaikan pembelian.</p>
                        
                        <div class="d-flex justify-content-center my-4">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/QRIS_Standard_2021.svg" alt="Kode QRIS" style="width: 250px; height: 250px; object-fit: contain;">
                        </div>

                        <div class="text-start mb-4 p-3 border rounded">
                            <h5 class="fw-bold">Detail Transaksi</h5>
                            <p class="mb-1">Produk: <span id="paymentProductName" class="fw-semibold">...</span></p>
                            <p class="mb-1">Total Bayar: <span id="paymentTotal" class="fw-bold text-primary">Rp 0</span></p>
                            <p class="mb-0 small text-muted">ID Transaksi: <span id="paymentId">TRX-0000-0000</span></p>
                        </div>

                        <button id="payButton" class="btn btn-lg btn-success w-100 mt-3">Simulasikan Pembayaran Berhasil</button>
                        <a href="javascript:history.back()" class="btn btn-sm btn-outline-danger w-100 mt-2">Batal dan Kembali</a>

                        <p class="mt-4 small text-muted">Pembayaran ini disimulasikan. Setelah tombol 'Pembayaran Berhasil' ditekan, data checkout akan disimpan dan Anda akan menerima konfirmasi.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 Karyaku. All Rights Reserved.</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="db-utils.js"></script>
    <script src="navbar-utils.js"></script>
    
    <script>
        let currentProduct = null;
        
        async function initPaymentPage() {
            const IS_LOGGED_IN = localStorage.getItem('karyaku_is_logged_in') === 'true';
            const checkoutItemJson = localStorage.getItem('karyaku_checkout_item');
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!IS_LOGGED_IN || !productId || !checkoutItemJson) {
                alert("Akses tidak valid. Silakan mulai checkout dari halaman produk.");
                window.location.href = 'home.html';
                return;
            }

            try {
                currentProduct = JSON.parse(checkoutItemJson);
                if (currentProduct.id !== productId) {
                    throw new Error("Product ID mismatch");
                }
            } catch (e) {
                alert("Data produk checkout hilang atau rusak.");
                window.location.href = `product-detail.html?id=${productId}`;
                return;
            }
            
            // Update UI
            document.getElementById('paymentProductName').textContent = currentProduct.name;
            document.getElementById('paymentTotal').textContent = currentProduct.price;
            document.getElementById('paymentId').textContent = `TRX-${Date.now().toString().slice(-8)}`;

            document.getElementById('payButton').addEventListener('click', processPayment);
        }

        async function processPayment() {
            if (!currentProduct) return;
            
            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.textContent = 'Memproses Transaksi...';

            // Get user info
            const userId = localStorage.getItem('karyaku_creator_id') || '';
            const username = localStorage.getItem('karyaku_username') || '';
            const userEmail = localStorage.getItem('karyaku_user_email') || '';
            
            // Save to database
            await initDatabase();
            const result = await addCheckout(
                userId,
                username,
                currentProduct.id,
                currentProduct.name,
                currentProduct.price,
                currentProduct.creator_id || '',
                currentProduct.creator || ''
            );
            
            if (result.success) {
                // Clear temporary checkout item
                localStorage.removeItem('karyaku_checkout_item');

                // Redirect ke halaman sukses dengan informasi
                window.location.href = `success.html?product=${encodeURIComponent(currentProduct.name)}&email=${encodeURIComponent(userEmail)}`;
            } else {
                alert("Terjadi kesalahan saat menyimpan data checkout. Silakan coba lagi.");
                payButton.disabled = false;
                payButton.textContent = 'Simulasikan Pembayaran Berhasil';
            }
        }

        initPaymentPage();
    </script>
</body>
</html>