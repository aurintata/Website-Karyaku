<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kreator - Karyaku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="home.html">Karyaku</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="marketplace.html">Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link" href="creator-profile.html">Kreator</a></li>
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html">Dashboard</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-5 pt-5 pb-5">
        <div class="row align-items-center mb-4 pt-3">
            <div class="col-md-8">
                <h1 class="fw-bold mb-1">Dashboard Saya</h1>
                <p class="text-muted">Halo <span id="welcomeName" class="fw-bold text-dark">...</span>, ini ringkasan aktivitas kreatifmu.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="creator-profile.html" class="btn btn-primary">
                    <span class="me-1">üñºÔ∏è</span> Upload Karya Baru
                </a>
            </div>
        </div>

        <div id="dashboardAlert"></div>

        <section class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="dashboard-stat-card border-start border-primary border-5">
                    <p class="dashboard-stat-label">Karya Diupload</p>
                    <h2 class="dashboard-stat-value text-primary" id="myProductsCount">0</h2>
                    <p class="text-muted small mb-0">Total portofolio aktif di galeri</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-stat-card border-start border-success border-5">
                    <p class="dashboard-stat-label">Total Penjualan</p>
                    <h2 class="dashboard-stat-value text-success" id="mySalesCount">0</h2>
                    <p class="text-muted small mb-0">Transaksi berhasil diterima</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-stat-card border-start border-warning border-5">
                    <p class="dashboard-stat-label">Aktivitas Terakhir</p>
                    <h4 class="fw-bold mt-2 mb-1" id="lastLoginDate">-</h4>
                    <p class="text-muted small mb-0" id="lastLoginTime">Login terakhir</p>
                </div>
            </div>
        </section>

        <div class="row g-4">
            <div class="col-12">
                <div class="card shadow-sm border-0 h-100 overflow-hidden">
                    <div class="card-header bg-white py-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">üé® Karya Saya</h5>
                            <small class="text-muted">Portofolio yang telah Anda upload</small>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dashboard table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40%">Karya</th>
                                    <th>Harga</th>
                                    <th>Tanggal Upload</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="myProductsTable">
                                <tr><td colspan="4" class="text-center py-5 text-muted">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100 overflow-hidden">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold">üí∞ Riwayat Penjualan</h5>
                        <small class="text-muted d-block mt-1">Pembeli karya Anda</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dashboard table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Pembeli</th>
                                    <th>Item Terjual</th>
                                    <th class="text-end">Waktu</th>
                                </tr>
                            </thead>
                            <tbody id="mySalesTable">
                                <tr><td colspan="3" class="text-center py-5 text-muted">Belum ada penjualan.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100 overflow-hidden">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold">üîê Aktivitas Login</h5>
                        <small class="text-muted d-block mt-1">Riwayat akses akun Anda</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dashboard table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Waktu</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="myLoginsTable">
                                <tr><td colspan="3" class="text-center py-5 text-muted">Memuat log...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 Karyaku. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="db-utils.js"></script>
    <script src="navbar-utils.js"></script>
    <script>
        (function () {
            // Cek Autentikasi
            const isLoggedIn = localStorage.getItem('karyaku_is_logged_in') === 'true';
            const currentCreatorId = localStorage.getItem('karyaku_creator_id');
            const currentUserEmail = localStorage.getItem('karyaku_user_email');
            const currentUserName = localStorage.getItem('karyaku_username');

            if (!isLoggedIn || !currentCreatorId) {
                document.querySelector('main').innerHTML = `
                    <div class="text-center py-5">
                        <h3 class="mb-3">Akses Ditolak</h3>
                        <p class="text-muted mb-4">Silakan login untuk melihat dashboard personal Anda.</p>
                        <a href="auth.html" class="btn btn-primary">Masuk Sekarang</a>
                    </div>`;
                return;
            }

            document.getElementById('welcomeName').textContent = currentUserName || 'Kreator';

            const elements = {
                statProducts: document.getElementById('myProductsCount'),
                statSales: document.getElementById('mySalesCount'),
                statLoginDate: document.getElementById('lastLoginDate'),
                statLoginTime: document.getElementById('lastLoginTime'),
                tables: {
                    products: document.getElementById('myProductsTable'),
                    sales: document.getElementById('mySalesTable'),
                    logins: document.getElementById('myLoginsTable')
                }
            };

            const dateTimeFormatter = new Intl.DateTimeFormat('id-ID', { dateStyle: 'medium', timeStyle: 'short' });

            function formatDate(value) {
                if (!value) return '-';
                try { return dateTimeFormatter.format(new Date(value)); } catch(e) { return value; }
            }

            async function loadPersonalDashboard() {
                try {
                    const db = await initDatabase();

                    // 1. DATA KARYA SAYA
                    const myProducts = await getProductsByCreatorId(currentCreatorId);

                    // 2. DATA PENJUALAN SAYA (Query manual: SELECT WHERE creator_id = saya)
                    let mySales = [];
                    try {
                        const stmt = db.prepare("SELECT username, product_name, price, timestamp FROM checkouts WHERE creator_id = ? ORDER BY timestamp DESC");
                        stmt.bind([currentCreatorId]);
                        while (stmt.step()) {
                            const row = stmt.get();
                            mySales.push({ buyer: row[0], product: row[1], price: row[2], date: row[3] });
                        }
                        stmt.free();
                    } catch (e) { console.error("Sales query error", e); }

                    // 3. DATA LOGIN SAYA
                    let myLogins = [];
                    try {
                        const stmt = db.prepare("SELECT login_date, timestamp, status FROM logins WHERE email = ? ORDER BY timestamp DESC LIMIT 10");
                        stmt.bind([currentUserEmail]);
                        while (stmt.step()) {
                            const row = stmt.get();
                            myLogins.push({ dateStr: row[0], timestamp: row[1], status: row[2] });
                        }
                        stmt.free();
                    } catch (e) { console.error("Login query error", e); }

                    // --- UPDATE UI STATS ---
                    elements.statProducts.textContent = myProducts.length;
                    elements.statSales.textContent = mySales.length;
                    
                    if (myLogins.length > 0) {
                        const last = new Date(myLogins[0].timestamp);
                        elements.statLoginDate.textContent = last.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                        elements.statLoginTime.textContent = last.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                    } else {
                        elements.statLoginDate.textContent = "Baru saja";
                    }

                    // --- RENDER TABLE 1: PRODUCTS ---
                    if (myProducts.length === 0) {
                        elements.tables.products.innerHTML = `<tr><td colspan="4" class="text-center py-5"><p class="text-muted mb-2">Anda belum mengupload karya.</p><a href="creator-profile.html" class="btn btn-sm btn-outline-primary">Mulai Upload</a></td></tr>`;
                    } else {
                        elements.tables.products.innerHTML = myProducts.map(p => `
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded me-3 bg-light d-flex align-items-center justify-content-center overflow-hidden" style="width: 48px; height: 48px;">
                                            <img src="${p.image_url}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/50'">
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">${p.title}</div>
                                            <small class="text-muted font-monospace" style="font-size: 0.75rem">${p.product_id}</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-semibold text-primary">${p.price}</td>
                                <td class="text-muted small">${formatDate(p.created_at)}</td>
                                <td><span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">Aktif</span></td>
                            </tr>
                        `).join('');
                    }

                    // --- RENDER TABLE 2: SALES ---
                    if (mySales.length === 0) {
                        elements.tables.sales.innerHTML = `<tr><td colspan="3" class="text-center py-5 text-muted">Belum ada karya Anda yang terjual. Promosikan karyamu!</td></tr>`;
                    } else {
                        elements.tables.sales.innerHTML = mySales.map(s => `
                            <tr>
                                <td>
                                    <div class="fw-bold">${s.buyer}</div>
                                    <small class="text-muted">Pembeli</small>
                                </td>
                                <td>
                                    <div class="text-dark">${s.product}</div>
                                    <small class="text-success fw-bold">${s.price}</small>
                                </td>
                                <td class="text-end text-muted small">${formatDate(s.date)}</td>
                            </tr>
                        `).join('');
                    }

                    // --- RENDER TABLE 3: LOGINS ---
                    if (myLogins.length === 0) {
                        elements.tables.logins.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-muted">Tidak ada riwayat.</td></tr>`;
                    } else {
                        elements.tables.logins.innerHTML = myLogins.map(l => `
                            <tr>
                                <td class="text-muted">${formatDate(l.timestamp).split(' pukul')[0]}</td>
                                <td class="text-muted">${new Date(l.timestamp).toLocaleTimeString('id-ID')}</td>
                                <td class="text-center">
                                    <span class="badge ${l.status === 'success' ? 'bg-success' : 'bg-danger'} rounded-pill">
                                        ${l.status === 'success' ? 'Sukses' : 'Gagal'}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                    }

                } catch (error) {
                    console.error('Error dashboard:', error);
                    document.getElementById('dashboardAlert').innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${error.message}</div>`;
                }
            }

            loadPersonalDashboard();
        })();
    </script>
</body>
</html>