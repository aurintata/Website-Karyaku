<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data - Karyaku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="home.html">Karyaku</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="marketplace.html">Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link" href="creator-profile.html">Kreator</a></li>
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html">Dashboard</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-5 pt-4 pb-5">
        <section class="text-center py-4">
            <h1 class="fw-bold mb-3">Dashboard Data Karyaku</h1>
            <p class="text-muted mb-0">Pantau data kreator, karya, login, dan aktivitas checkout langsung dari database browser.</p>
        </section>

        <div id="dashboardAlert"></div>

        <section class="row g-4 mb-5">
            <div class="col-md-6 col-lg-3">
                <div class="dashboard-stat-card">
                    <p class="dashboard-stat-label">Total Kreator</p>
                    <h2 class="dashboard-stat-value" id="usersCount">-</h2>
                    <p class="dashboard-stat-subtitle text-muted">Akun terdaftar</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="dashboard-stat-card">
                    <p class="dashboard-stat-label">Total Karya</p>
                    <h2 class="dashboard-stat-value" id="productsCount">-</h2>
                    <p class="dashboard-stat-subtitle text-muted">Produk digital tersimpan</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="dashboard-stat-card">
                    <p class="dashboard-stat-label">Log Aktivitas</p>
                    <h2 class="dashboard-stat-value" id="loginsCount">-</h2>
                    <p class="dashboard-stat-subtitle text-muted">Total catatan login</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="dashboard-stat-card">
                    <p class="dashboard-stat-label">Checkout</p>
                    <h2 class="dashboard-stat-value" id="checkoutsCount">-</h2>
                    <p class="dashboard-stat-subtitle text-muted">Transaksi tersimpan</p>
                </div>
            </div>
        </section>

        <section class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Daftar Kreator</h5>
                    <small class="text-muted">Semua pengguna yang tersimpan di tabel <code>users</code></small>
                </div>
                <span class="badge rounded-pill text-bg-light" id="usersTotalLabel">- akun</span>
            </div>
            <div class="table-responsive">
                <table class="table table-dashboard align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>ID Kreator</th>
                            <th>Terdaftar</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Memuat data kreator...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Daftar Karya</h5>
                    <small class="text-muted">Semua produk digital yang tersimpan di tabel <code>products</code></small>
                </div>
                <span class="badge rounded-pill text-bg-light" id="productsTotalLabel">- karya</span>
            </div>
            <div class="table-responsive">
                <table class="table table-dashboard align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Kreator</th>
                            <th>Harga</th>
                            <th>Dibuat</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Memuat data produk...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Riwayat Login Terbaru</h5>
                    <small class="text-muted">Menampilkan maksimal 10 aktivitas terakhir dari tabel <code>logins</code></small>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dashboard align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Pengguna</th>
                            <th>Status</th>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="loginsTableBody">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Menunggu aktivitas login...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Checkout Terbaru</h5>
                    <small class="text-muted">Menampilkan maksimal 10 catatan checkout dari tabel <code>checkouts</code></small>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dashboard align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Pembeli</th>
                            <th>Harga</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="checkoutsTableBody">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Belum ada data checkout.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 Karyaku. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="db-utils.js"></script>
    <script src="navbar-utils.js"></script>
    <script>
        (function () {
            const elements = {
                alert: document.getElementById('dashboardAlert'),
                statUsers: document.getElementById('usersCount'),
                statProducts: document.getElementById('productsCount'),
                statLogins: document.getElementById('loginsCount'),
                statCheckouts: document.getElementById('checkoutsCount'),
                usersTotalLabel: document.getElementById('usersTotalLabel'),
                productsTotalLabel: document.getElementById('productsTotalLabel'),
                tables: {
                    users: document.getElementById('usersTableBody'),
                    products: document.getElementById('productsTableBody'),
                    logins: document.getElementById('loginsTableBody'),
                    checkouts: document.getElementById('checkoutsTableBody')
                }
            };

            const dateTimeFormatter = new Intl.DateTimeFormat('id-ID', {
                dateStyle: 'medium',
                timeStyle: 'short'
            });

            const dateFormatter = new Intl.DateTimeFormat('id-ID', {
                dateStyle: 'medium'
            });

            function escapeHtml(value) {
                return (value ?? '').toString().replace(/[&<>"']/g, function (char) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[char] || char;
                });
            }

            function formatDate(value, withTime = true) {
                if (!value) return '-';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return typeof value === 'string' && value.trim() ? value : '-';
                }
                return withTime ? dateTimeFormatter.format(date) : dateFormatter.format(date);
            }

            function showEmptyRow(tbody, message) {
                if (!tbody) return;
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${tbody.parentElement.querySelectorAll('thead th').length}" class="text-center text-muted py-4">${message}</td>
                    </tr>
                `;
            }

            function updateStats(stats) {
                elements.statUsers.textContent = stats.users;
                elements.statProducts.textContent = stats.products;
                elements.statLogins.textContent = stats.logins;
                elements.statCheckouts.textContent = stats.checkouts;
                elements.usersTotalLabel.textContent = `${stats.users} akun`;
                elements.productsTotalLabel.textContent = `${stats.products} karya`;
            }

            function renderUsers(users) {
                const tbody = elements.tables.users;
                if (!users || users.length === 0) {
                    showEmptyRow(tbody, 'Belum ada data pengguna.');
                    return;
                }

                const rows = users.map(user => `
                    <tr>
                        <td>
                            <span class="fw-semibold">${escapeHtml(user.name || 'Tanpa Nama')}</span>
                            <div class="small text-muted">${escapeHtml(user.description || user.bio || '')}</div>
                        </td>
                        <td>${escapeHtml(user.email)}</td>
                        <td><code>${escapeHtml(user.creator_id || '-')}</code></td>
                        <td>${formatDate(user.registered_at, false)}</td>
                    </tr>
                `).join('');
                tbody.innerHTML = rows;
            }

            function renderProducts(products, users) {
                const tbody = elements.tables.products;
                if (!products || products.length === 0) {
                    showEmptyRow(tbody, 'Belum ada karya yang tersimpan.');
                    return;
                }

                const creatorLookup = {};
                (users || []).forEach(user => {
                    if (user.creator_id) {
                        creatorLookup[user.creator_id] = user.name;
                    }
                });

                const sortedProducts = [...products].sort((a, b) => {
                    return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                });

                const rows = sortedProducts.map(product => `
                    <tr>
                        <td>
                            <span class="fw-semibold">${escapeHtml(product.title || 'Tanpa Judul')}</span>
                            <div class="small text-muted">${escapeHtml(product.product_id || '')}</div>
                        </td>
                        <td>${escapeHtml(creatorLookup[product.creator_id] || product.creator_id || '-')}</td>
                        <td>${escapeHtml(product.price || 'Rp -')}</td>
                        <td>${formatDate(product.created_at)}</td>
                    </tr>
                `).join('');
                tbody.innerHTML = rows;
            }

            function renderLogins(logins) {
                const tbody = elements.tables.logins;
                if (!logins || logins.length === 0) {
                    showEmptyRow(tbody, 'Belum ada aktivitas login yang tercatat.');
                    return;
                }

                const rows = logins.map(login => {
                    const badgeClass = login.status === 'success' ? 'text-bg-success' : 'text-bg-danger';
                    const badgeLabel = login.status === 'success' ? 'Berhasil' : 'Gagal';
                    return `
                        <tr>
                            <td>
                                <span class="fw-semibold">${escapeHtml(login.username || login.email || 'Pengguna')}</span>
                                <div class="small text-muted">${escapeHtml(login.email || '')}</div>
                            </td>
                            <td><span class="badge rounded-pill ${badgeClass}">${badgeLabel}</span></td>
                            <td>${escapeHtml(login.login_date || '-')}</td>
                            <td>${formatDate(login.timestamp)}</td>
                        </tr>
                    `;
                }).join('');
                tbody.innerHTML = rows;
            }

            function renderCheckouts(checkouts) {
                const tbody = elements.tables.checkouts;
                if (!checkouts || checkouts.length === 0) {
                    showEmptyRow(tbody, 'Belum ada catatan checkout.');
                    return;
                }

                const rows = checkouts.map(checkout => `
                    <tr>
                        <td>
                            <span class="fw-semibold">${escapeHtml(checkout.product_name || 'Produk')}</span>
                            <div class="small text-muted">${escapeHtml(checkout.product_id || '')}</div>
                        </td>
                        <td>
                            <span class="fw-semibold">${escapeHtml(checkout.username || checkout.user_id || 'Pengguna')}</span>
                            <div class="small text-muted">${escapeHtml(checkout.creator_name ? `Kreator: ${checkout.creator_name}` : '')}</div>
                        </td>
                        <td>${escapeHtml(checkout.price || 'Rp -')}</td>
                        <td>${formatDate(checkout.timestamp)}</td>
                    </tr>
                `).join('');
                tbody.innerHTML = rows;
            }

            function showAlert(message) {
                if (!elements.alert) return;
                elements.alert.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        ${message}
                    </div>
                `;
            }

            function normalizeUsers(users) {
                if (users && users.length) return users;
                if (Array.isArray(window.KARYAKU_DEFAULT_CREATORS)) {
                    const now = new Date().toISOString();
                    return window.KARYAKU_DEFAULT_CREATORS.map(creator => ({
                        email: creator.email,
                        name: creator.name,
                        password: creator.password,
                        creator_id: creator.creator_id,
                        bio: creator.bio || '',
                        description: creator.description || '',
                        image: creator.image || '',
                        registered_at: now
                    }));
                }
                return [];
            }

            function normalizeProducts(products) {
                if (products && products.length) return products;
                if (Array.isArray(window.KARYAKU_DEFAULT_PRODUCTS)) {
                    const now = new Date().toISOString();
                    return window.KARYAKU_DEFAULT_PRODUCTS.map(product => ({
                        id: product.product_id,
                        product_id: product.product_id,
                        creator_id: product.creator_id,
                        title: product.title,
                        price: product.price,
                        description: product.description || '',
                        image_url: product.image_url || '',
                        filename: product.filename || '',
                        specs: product.specs || '',
                        created_at: now
                    }));
                }
                return [];
            }

            async function loadDashboardData() {
                try {
                    await initDatabase();

                    let [users, products, logins, checkouts] = await Promise.all([
                        getAllUsers(),
                        getAllProducts(),
                        getRecentLogins(10),
                        getRecentCheckouts(10)
                    ]);

                    users = normalizeUsers(users);
                    products = normalizeProducts(products);

                    const stats = {
                        users: users.length,
                        products: products.length,
                        logins: getTableCount('logins') || logins.length,
                        checkouts: getTableCount('checkouts') || checkouts.length
                    };

                    updateStats(stats);
                    renderUsers(users);
                    renderProducts(products, users);
                    renderLogins(logins);
                    renderCheckouts(checkouts);
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showAlert('Gagal memuat data dashboard. Silakan muat ulang halaman atau periksa console untuk detail.');
                }
            }

            loadDashboardData();
        })();
    </script>
</body>
</html>

