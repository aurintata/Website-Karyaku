<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="productTitlePage">Detail Produk - Karyaku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="home.html">Karyaku</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="marketplace.html">Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link" href="creator-profile.html">Kreator</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-5 pt-5">
        <div class="row">
            <div class="col-md-7">
                <div class="card-img-wrapper"> 
                    <img src="https://via.placeholder.com/800x600.png?text=Loading..." class="rounded shadow-lg" id="productImage" alt="Karya Seni">
                </div>
            </div>
            <div class="col-md-5">
                <h1 class="display-5" id="productName">Loading Product Name...</h1>
                <p class="fs-4 text-primary fw-bold" id="productPrice">Rp X.XXX.XXX</p>
                <hr>
                <div class="d-flex align-items-center mb-3">
                    <div class="creator-avatar-wrapper me-3">
                        <img src="https://via.placeholder.com/70x70.png?text=C" class="creator-avatar" id="creatorImage" alt="Kreator" onerror="this.onerror=null;this.src='https://via.placeholder.com/70x70.png?text=' + (this.alt || 'K')">
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0">Dibuat oleh: <a href="creator-profile.html" id="creatorName">Loading Kreator...</a></h6>
                        <small class="text-muted">Kreator verified</small>
                    </div>
                </div>
                <p><strong>Deskripsi Karya:</strong></p>
                <p class="text-muted" id="productDescription">Deskripsi dimuat berdasarkan ID produk...</p>
                
                <p><strong>Rincian Produk:</strong></p>
                <ul id="productSpecs">
                    <li>Format: Loading...</li>
                </ul>
                <a href="javascript:void(0)" id="checkoutButton" class="btn btn-lg btn-primary w-100">Beli Sekarang / Checkout</a>
                <button class="btn btn-outline-secondary w-100 mt-2">Tambahkan ke Keranjang</button>
            </div>
        </div>
        <div class="text-center my-5">
            <h3 class="mb-4">Karya Kreator Lain</h3>
            <a href="marketplace.html" class="btn btn-lg btn-outline-secondary">Lihat Karya Lain</a>
        </div>
    </div>
    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 Karyaku. All Rights Reserved.</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="db-utils.js"></script>
    <script src="navbar-utils.js"></script>
    
    <script>
        // Load products from database
        let products = {};
        
        // Default products (fallback)
        const defaultProducts = {
            'aysar_berkelana': {
                name: "Berkelana", creator: "Muhammad Aysar Rayyya", creator_id: "aysar", price: "Rp 250.000",
                desc: "Ilustrasi petualangan futuristik yang menginspirasi kebebasan menjelajah.",
                img: "https://instructor-academy.onlinecoursehost.com/content/images/2023/05/58_Top-10-Successful-Graphic-Design-Course-Creators.jpg", 
                specs: ["Format: PNG, JPEG", "Dimensi: 5000x4000px", "Lisensi: Penggunaan Pribadi"]
            },
            'shafa_tech': {
                name: "Tech Innovation", creator: "Shafa Lifia", creator_id: "shafa", price: "Rp 180.041",
                desc: "Konsep art minimalis bertema teknologi, menunjukkan integrasi manusia dan mesin.",
                img: "https://tse1.mm.bing.net/th/id/OIP.k_DhPlgpaSDciS5H9SoEZgHaE8?pid=Api&P=0&h=180", 
                specs: ["Format: JPEG", "Dimensi: 3000x2000px", "Lisensi: Komersial Terbatas"]
            },
            'rafifferre_cyber': {
                name: "Cyberpunk City", creator: "Rafifferre Narendra", creator_id: "rafifferre", price: "Rp 320.054",
                desc: "Pemandangan kota cyberpunk yang penuh neon dengan detail arsitektur yang kompleks.",
                img: "https://tse4.mm.bing.net/th/id/OIP.3ehusjzsp4pipVLFFEaZbgHaHa?pid=Api&P=0&h=180", 
                specs: ["Format: PNG, PDF", "Dimensi: 6000x6000px", "Lisensi: Penggunaan Pribadi"]
            },
            'aysar_ruins': {
                name: "Ancient Ruins", creator: "Muhammad Aysar Rayyya", creator_id: "aysar", price: "Rp 160.066",
                desc: "Lukisan digital reruntuhan kuno dengan atmosfer misterius dan pencahayaan dramatis.",
                img: "https://tse4.mm.bing.net/th/id/OIP.Q_M-c9LkzOXOJF5XrOO8EgHaEO?pid=Api&P=0&h=180", 
                specs: ["Format: PNG", "Dimensi: 4500x3000px", "Lisensi: Penggunaan Pribadi"]
            },
            'shafa_fantasy': {
                name: "Fantasy Portrait", creator: "Shafa Lifia", creator_id: "shafa", price: "Rp 200.036",
                desc: "Potret fantasi dengan detail yang halus dan fokus pada ekspresi wajah.",
                img: "https://tse1.mm.bing.net/th/id/OIP.zMUNwk9sUu-QzrJW9wVAhwHaFn?pid=Api&P=0&h=180", 
                specs: ["Format: JPEG", "Dimensi: 3500x3500px", "Lisensi: Penggunaan Pribadi"]
            },
            'rafifferre_eye': {
                name: "Deep Eye", creator: "Rafifferre Narendra", creator_id: "rafifferre", price: "Rp 195.054",
                desc: "Ilustrasi mata manusia yang dalam, dengan refleksi lanskap kosmik di dalamnya.",
                img: "https://tse3.mm.bing.net/th/id/OIP.d3bi3-ETF7sYyxtFVgYfQwHaEO?pid=Api&P=0&h=180", 
                specs: ["Format: PNG", "Dimensi: 3000x2000px", "Lisensi: Komersial Terbatas"]
            },
            'creative_waves': {
                name: "Abstract Waves", creator: "CreativeMind", creator_id: "creativemind", price: "Rp 100.000",
                desc: "Seni abstrak berbentuk gelombang dengan komposisi warna yang cerah dan dinamis.",
                img: "https://tse3.mm.bing.net/th/id/OIP.nIA7p4ZGKlDMgB1lfkFjHwHaJQ?pid=Api&P=0&h=180", 
                specs: ["Format: JPEG", "Dimensi: 2000x3000px", "Lisensi: Penggunaan Pribadi"]
            },
            'artflow_forest': {
                name: "Enchanted Forest", creator: "ArtFlow Studio", creator_id: "artflow", price: "Rp 275.000",
                desc: "Pemandangan hutan fantasi yang memikat, penuh dengan cahaya ajaib dan detail flora.",
                img: "https://tse1.mm.bing.net/th/id/OIP.SYdakG1lzGqvXTnfGKo8KwHaFj?pid=Api&P=0&h=180", 
                specs: ["Format: PNG", "Dimensi: 5000x5000px", "Lisensi: Penggunaan Pribadi"]
            },
            'shafa_oceanic': {
                name: "Oceanic Dream", creator: "Shafa Lifia", creator_id: "shafa", price: "Rp 350.000",
                desc: "Ilustrasi bawah laut dengan sentuhan fantasi, menampilkan makhluk laut yang bercahaya.",
                img: "https://tse1.mm.bing.net/th/id/OIP.yHB6xbazdF1YlaoxH0kpuAHaJ4?pid=Api&P=0&h=180",
                specs: ["Format: PNG", "Dimensi: 4500x5500px", "Lisensi: Penggunaan Pribadi"]
            },
            'audrick_cityscape': {
                name: "Future Cityscape", creator: "Muhammad Audrick", creator_id: "audrick", price: "Rp 280.000",
                desc: "Pemandangan kota futuristik (Cityscape) dengan lampu neon yang detail. Cocok untuk kolektor Cyberpunk.",
                img: "https://tse4.mm.bing.net/th/id/OIP.3jeyUch2pP-GJ4dE6dt8kAHaEK?pid=Api&P=0&h=180",
                specs: ["Format: JPEG", "Dimensi: 4000x2500px", "Lisensi: Penggunaan Pribadi"]
            },
            'tafta_abstract': {
                name: "Soft Abstract", creator: "Tafta Aurinnisa", creator_id: "tafta", price: "Rp 150.070",
                desc: "Karya seni abstrak dengan palet warna lembut dan menenangkan. Cocok untuk interior minimalis.",
                img: "https://tse4.mm.bing.net/th/id/OIP.EJSVNFXnfjV3g9uhr9kYHgHaDt?pid=Api&P=0&h=180",
                specs: ["Format: JPEG", "Dimensi: 2500x1500px", "Lisensi: Komersial Terbatas"]
            },
            'naufal_portrait': {
                name: "Minimal Portrait", creator: "Naufal Satria", creator_id: "naufal", price: "Rp 200.045",
                desc: "Potret minimalis dengan garis-garis tegas, menonjolkan ekspresi subjek.",
                img: "https://tse2.mm.bing.net/th/id/OIP.5Z5LA3dGH5VmvBRpOZLzgwHaFj?pid=Api&P=0&h=180",
                specs: ["Format: PNG", "Dimensi: 3000x3000px", "Lisensi: Penggunaan Pribadi"]
            },
            'aysar_lofi': {
                name: "Lofi Scenery", creator: "Muhammad Aysar", creator_id: "aysar", price: "Rp 220.066",
                desc: "Pemandangan Lofi malam hari di Paris, sangat cocok untuk menemani saat bersantai.",
                img: "https://worldofprintables.com/wp-content/uploads/2023/06/Paris-Night-Scene-Lofi-Background-1536x861.jpg",
                specs: ["Format: JPEG", "Dimensi: 4000x2000px", "Lisensi: Penggunaan Pribadi"]
            },
            'rafifferre_sea': {
                name: "Deep Sea Creatures", creator: "Rafifferre Narendra", creator_id: "rafifferre", price: "Rp 300.054",
                desc: "Ilustrasi makhluk laut dalam yang misterius dan penuh warna.",
                img: "https://tse3.mm.bing.net/th/id/OIP.X5ZtzpM8JaThYiDmvA4EPwHaFV?pid=Api&P=0&h=180",
                specs: ["Format: PNG", "Dimensi: 4000x3000px", "Lisensi: Penggunaan Pribadi"]
            }
        };
        
        // Load products from database
        async function loadProductsFromDatabase() {
            try {
                await initDatabase();
                const dbProducts = await getAllProducts();
                
                // Convert database products to the format expected by loadProductDetails
                products = {};
                
                // Process all products with async creator lookups
                for (const dbProduct of dbProducts) {
                    const user = await getUserByCreatorId(dbProduct.creator_id);
                    products[dbProduct.product_id] = {
                        name: dbProduct.title,
                        creator: user ? user.name : 'Unknown Creator',
                        creator_id: dbProduct.creator_id,
                        creator_image: user ? (user.image || '') : '',
                        price: dbProduct.price,
                        desc: dbProduct.description || '',
                        img: dbProduct.image_url || 'https://via.placeholder.com/800x600.png?text=Karya',
                        specs: dbProduct.specs ? dbProduct.specs.split(', ') : ["Format: JPEG", "Dimensi: Bervariasi", "Lisensi: Penggunaan Pribadi"]
                    };
                }
                
                // Also merge with default products (database products take precedence if ID conflicts)
                products = { ...defaultProducts, ...products };
            } catch (error) {
                console.error('Error loading products:', error);
                // Fallback to default products
                products = defaultProducts;
            }
        }

        async function loadProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            let product = products[productId];
            const creatorLink = document.getElementById('creatorName');
            const specsList = document.getElementById('productSpecs');
            const checkoutBtn = document.getElementById('checkoutButton');

            if (product) {
                // If product doesn't have creator_image, fetch it from database
                if (!product.creator_image && product.creator_id) {
                    try {
                        const user = await getUserByCreatorId(product.creator_id);
                        if (user && user.image) {
                            product.creator_image = user.image;
                        }
                    } catch (error) {
                        console.error('Error fetching creator image:', error);
                    }
                }

                document.getElementById('productName').innerText = product.name;
                document.getElementById('productPrice').innerText = product.price;
                document.getElementById('productDescription').innerText = product.desc;
                document.getElementById('productImage').src = product.img;
                document.getElementById('productImage').alt = product.name;
                document.getElementById('productTitlePage').innerText = product.name + " - Karyaku"; 

                // Info Kreator
                creatorLink.innerText = product.creator;
                creatorLink.href = `creator-profile.html?id=${product.creator_id}`;

                // Spesifikasi
                specsList.innerHTML = '';
                product.specs.forEach(spec => {
                    const li = document.createElement('li');
                    li.textContent = spec;
                    specsList.appendChild(li);
                });

                // Set creator avatar image with proper fallback
                const creatorImageEl = document.getElementById('creatorImage');
                const creatorInitial = product.creator ? product.creator.trim().charAt(0).toUpperCase() : 'K';
                const placeholderUrl = `https://via.placeholder.com/70x70.png?text=${encodeURIComponent(creatorInitial)}`;
                
                if (product.creator_image && product.creator_image.trim()) {
                    creatorImageEl.src = product.creator_image;
                    creatorImageEl.alt = product.creator;
                } else {
                    creatorImageEl.src = placeholderUrl;
                    creatorImageEl.alt = product.creator;
                }
                
                // Fungsi Checkout Berjalan with Database Saving
                checkoutBtn.onclick = async function() {
                    // Get user info
                    const IS_LOGGED_IN = localStorage.getItem('karyaku_is_logged_in') === 'true';
                    if (!IS_LOGGED_IN) {
                        alert("Anda harus login terlebih dahulu untuk melakukan checkout!");
                        window.location.href = `auth.html?redirect=${productId}`;
                        return;
                    }
                    
                    const userId = localStorage.getItem('karyaku_creator_id') || '';
                    const username = localStorage.getItem('karyaku_username') || '';
                    
                    // Save to database
                    const result = await addCheckout(
                        userId,
                        username,
                        productId,
                        product.name,
                        product.price,
                        product.creator_id || '',
                        product.creator || ''
                    );
                    
                    if (result.success) {
                        alert(`CHECKOUT BERHASIL!\n\nAnda berhasil memesan karya: ${product.name}\nTotal Harga: ${product.price}\n\nData checkout telah disimpan ke database. Link unduh akan segera dikirim ke email Anda. Terima kasih telah mendukung kreator lokal!`);
                        window.location.href = 'home.html';
                    } else {
                        alert("Terjadi kesalahan saat melakukan checkout. Silakan coba lagi.");
                    }
                };

            } else {
                // Not Found State
                document.getElementById('productName').innerText = "Karya Tidak Ditemukan";
                document.getElementById('productPrice').innerText = "";
                document.getElementById('productDescription').innerText = "Maaf, ID produk yang Anda cari tidak valid.";
                document.getElementById('productImage').src = "https://via.placeholder.com/800x600.png?text=404+Karya+Tidak+Ada";
                creatorLink.innerText = "Karyaku Support";
                creatorLink.href = "home.html";
                specsList.innerHTML = '<li>Informasi tidak tersedia.</li>';
                checkoutBtn.className += ' disabled';
            }
        }

        // Initialize and load products
        loadProductsFromDatabase().then(() => {
            loadProductDetails().catch(error => {
                console.error('Error loading product details:', error);
            });
        });
    </script>
</body>
</html>