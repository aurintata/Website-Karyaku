<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk / Daftar - Karyaku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light d-flex align-items-center justify-content-center vh-100">
    <div class="card p-4 shadow-lg" style="width: 25rem;">
        <div class="card-body">
            <h2 class="text-center mb-4 fw-bold">Karyaku</h2>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="authTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">Masuk</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">Daftar</button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="authTabContent">
                <!-- Login Form -->
                <div class="tab-pane fade show active" id="login" role="tabpanel">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Masuk</button>
                    </form>
                </div>
                
                <!-- Register Form -->
                <div class="tab-pane fade" id="register" role="tabpanel">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerCreatorId" class="form-label">ID Kreator (untuk identifikasi)</label>
                            <input type="text" class="form-control" id="registerCreatorId" placeholder="contoh: shafa, aysar, dll" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Daftar</button>
                    </form>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <a href="home.html" class="text-muted text-decoration-none">Kembali ke Beranda</a>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="db-utils.js"></script>
    <script>
        // Check if user is already logged in
        const isLoggedIn = localStorage.getItem('karyaku_is_logged_in') === 'true';
        if (isLoggedIn) {
            // Redirect to home if already logged in
            window.location.href = 'home.html';
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const redirectId = urlParams.get('redirect'); 

        // Switch to register tab if mode=daftar
        if (mode === 'daftar') {
            const registerTab = document.getElementById('register-tab');
            const loginTab = document.getElementById('login-tab');
            const registerPane = document.getElementById('register');
            const loginPane = document.getElementById('login');
            
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerPane.classList.add('show', 'active');
            loginPane.classList.remove('show', 'active');
        }
        
        // REGISTRATION FORM HANDLER
        document.getElementById('registerForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const creatorId = document.getElementById('registerCreatorId').value.toLowerCase().trim();
            
            // Validation
            if (!name || !email || !password || !creatorId) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            if (password.length < 6) {
                alert('Password harus minimal 6 karakter!');
                return;
            }
            
            // Register user
            registerUser(name, email, password, creatorId).then(result => {
                if (result.success) {
                    // Set login state
                    localStorage.setItem('karyaku_is_logged_in', 'true');
                    localStorage.setItem('karyaku_username', result.user.name);
                    localStorage.setItem('karyaku_creator_id', result.user.creator_id);
                    localStorage.setItem('karyaku_user_email', result.user.email);

                    alert(`Akun untuk ${result.user.name} berhasil didaftarkan! Data telah disimpan ke database. Anda sekarang masuk. Anda akan diarahkan ke halaman profil untuk mulai upload!`);
                    
                    window.location.href = `creator-profile.html?id=${result.user.creator_id}`;
                } else {
                    alert(result.message);
                }
            });
        });
        
        // LOGIN FORM HANDLER
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Validation
            if (!email || !password) {
                alert('Mohon lengkapi email dan password!');
                return;
            }
            
            // Login user
            loginUser(email, password).then(result => {
                if (result.success) {
                    // Set login state
                    localStorage.setItem('karyaku_is_logged_in', 'true');
                    localStorage.setItem('karyaku_username', result.user.name);
                    localStorage.setItem('karyaku_creator_id', result.user.creator_id);
                    localStorage.setItem('karyaku_user_email', result.user.email);

                    alert(`Berhasil masuk sebagai ${result.user.name}! Data login telah disimpan ke database.`);

                    if (redirectId) {
                        window.location.href = `product-detail.html?id=${redirectId}`;
                    } else {
                        window.location.href = `creator-profile.html?id=${result.user.creator_id}`; 
                    }
                } else {
                    alert(result.message);
                }
            });
        });
    </script>
</body>
</html>
